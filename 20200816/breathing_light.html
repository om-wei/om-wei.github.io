<head>
<meta charset="UTF-8"/>
<title>呼吸灯➶ 一起干</title>
</head>
<h1>呼吸灯➶ 一起干</h1>
<p><img src="./breathing_light.gif" alt="摩托罗拉CLIQ手机上的呼吸灯"></br>
摩托罗拉CLIQ手机上的呼吸灯</br></br>


之前写了三篇硬件的小笔记，分别提到开关电源、步进电机、串口通信。如果想让他们配合起来做事情就需要软件赐予他们灵力了。</p>
<h4>浅谈软件</h4>
<p>有时候并不需要软件，比如自动冲厕装置（这个是电子设计的题目），可用定时器硬件搭建。还有半自动捆包机，这种控制上具有一定难度的机器，竟然也是完全用硬件电路搭建的。他们共同点是逻辑比较简单，状态少。延时、定时较固定。这需要很好的硬件设计能力。</br>
软件的执行需要计算机。形象但不太恰当的比喻，不同的软件好比是不同产品工艺流程手册，处理器好比工人和他们使用的工具，他们每个动作看起来简单重复，但是按照流程手册能做出不同的产品来。</br>
计算机由处理器、存储器、总线、输入/输出设备构成。软件是一系列按特定顺序组织的计算机指令和数据集合，存放在存储器中，由处理器执行。理论方面的知识请了解<a href="./图灵机.html">wikipedia:图灵机</a>，<a href="./通用图灵机.html">wikipedia:通用图灵机</a>，<a href="./有限状态机.html">wikipedia:有限状态机</a>。</br>
提到计算机，人们很容易想到PC、笔记本电脑，这只是其中一部分，还有很多各种各样的微控制器（MCU，俗称单片机）。可能在下一篇写些单片机的心得。量子计算机对自己来说还是未知领域。以AVR（来自挪威）ATMega16为例，它是一款8位微控制器，只有16K FLASH ROM，1K SRAM。这种资源贫瘠的东西可以做什么？</p>
<p>悬挂运动控制系统，这是电子设计的题目，也是大学实验室时期自己喜欢的小项目。控制两个步进电机让悬挂物在竖立的板上走直线、矩形、圆等图形。每个电子系统都离不开电源。这个项目里需要12V/24V电源供给步进电机驱动，5V电源供给ATmega16。使用步进电机驱动器，类似于TB6560驱动模块。开发过程中使用串口调试，后来移除了UART调试代码。网上这个题目的资源比较少，代码在这里<a href="https://github.com/om-wei/susp">github:susp</a>。接下来小巫见大巫，介绍个大巫~~~师。</br>
2009-2011年，最初由Simen Svale Skogsrud开源了一个业界知名的可用于3D打印机的gcode解析及运动控制程序——<strong>grbl</strong>。它主要改变了以前使用计算机并口（即25针打印机口）和并口控制板如MARCH的局面。用ATmega168实现了之前专用硬件的功能，用USB-UART替代并口，并且开源，所以更加简单好用。grbl开发初期运行在ATmega168，后来使用了ATmega328(32K FLASH ROM, 2K SRAM)。项目地址<a href="https://github.com/grbl/grbl">github:grbl</a> 在自己工作期间，就有不少关于3D打印的消息，但没有进一步了解，直至今年才认识到了这一点。</p>
<p>上面的代码，如果尝试去做，会更容易理解。自己也有几处没有弄明白，所以先从更简单的实例开始。</br>
呼吸灯，这里用了一种笨拙的办法。另外可以用硬件的脉冲宽度调制(PWM)、定时器或数模转化器(DAC)等其他方法。使用DAC可以减少发光二极管(LED)的开关次数。</p>
<p>设定硬件连接：ATmega16的PB3引脚串联电阻、LED后接地。PB3--R--LED--GND。高电平点亮LED，低电平关闭LED。</br>
如果想让LED有不同亮度，就要改变通过它的电流。PWM，调节占空比可以改变它的等效电流。占空比：50%是方波，100%是维持高电平，0%是维持低电平。如果脉冲之间的间隔足够短，利用视觉暂留现象，就可以使人看不出来LED实际上是在不停的开启/关闭。</br>
</p>
<p>AVR微控制器，C语言编程，Arduino IDE/winavr/avrgcc编译工具（不同的编译平台代码会有不同, 其他AVR编译器有ICC-AVR等）</br>
代码还没有测试，预先尴尬😅
</p>
<pre><code class="language-c">#include &lt;avr/io.h&gt;        
#include &lt;util/delay.h&gt;        

#define LEDPORT			PORTB
#define LEDDDR			DDRB
#define LED			PB3

#define INTERVAL		2000		/* 1/2 “呼吸”周期 */
#define DELTA			((INTERVAL)/50)	/* 调节占空比，增量 */

int main(void)
{
    int i = 0;

    LEDDDR |= _BV(LED); 	/* 通过配置I/O端口数据方向寄存器，设置LED为输出模式 */	
    
    while(1) {
	/* LED逐渐变亮 */
        for(i = 0; i &lt;= INTERVAL; i + DELTA) {
            LEDPORT |= _BV(LED);	/* 通过配置I/O端口数据寄存器，开启LED */
            _delay_ms(i);
            LEDPORT &amp;= ~_BV(LED);	/* 关闭LED */
            _delay_ms(INTERVAL - i);
        }
	/* LED逐渐变暗 */
        for(i = INTERVAL; i &gt;= 0; i - DELTA) {
            LEDPORT |= _BV(LED);
            _delay_ms(i);
            LEDPORT &amp;= ~_BV(LED);
            _delay_ms(INTERVAL - i);
        }
    }
}
</code></pre>
<p>寄存器及常用宏定义于avr/io.h 延时函数定义在util/delay.h 起始两行包含这两个头文件</br>
宏定义使代码更易懂、修改代码更方便</br>
微控制器上编程常常需要对位进行操作，为了在写操作的时候不影响其他位，使用了“读-修改-写”的方法</p>

<p>_BV(x)定义为 1 << (x), 即第x位为1，其它位为0。</br>
_delay_ms(t), 编译器根据定义的时钟频率会生成延时t毫秒的代码。</br>
这段代码中延时函数的执行几乎占据了CPU的全部时间。所以那手机上的呼吸灯可不是这样的。</p>

<p>其实，个人认为，我们的环境与欧美不同，社会从积贫积弱到发达稳定并没有多长时间。在电磁学上或者说整个现代自然科学上讲，我们的积淀并不太多，大学教育中很多是西方的舶来品。学生大都缺少感性的认识，好多东西学了不知道这是干啥使的，也不知道由啥来的。</br>
从自身讲，从职业期，进入到空档期，自己时常感到迷茫，&quot;学而不思则罔&quot;。技术是把双刃剑，怎么使剑往往不是再通过技术途径来指导。</p>
